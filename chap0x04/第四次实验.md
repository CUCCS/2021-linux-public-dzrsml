# 第四次实验

![](https://travis-ci.com/dzrsml/test.svg?branch=main)
## 实验环境
- 虚拟机：**Virtualbox**
  Ubuntu 20.04 Server 64bit
- 软件环境：**VScode,连接到虚拟机**
    - ShellCheck
    - Bash Debug


---

## 实验要求
1. 上述任务的所有源代码文件必须单独提交并提供详细的`--help`脚本内置帮助信息
2. 任务二\三的所有统计数据结果要求写入独立实验报告

实验结果已经在travis运行：https://github.com/dzrsml/test
---

## 完成情况

#### 任务一：用bash编写一个图片批处理脚本，实现以下功能：
- [x] 支持命令行参数方式使用不同功能
- [x] 支持对指定目录下所有支持格式的图片文件进行批处理
- [x] 支持以下常见图片批处理功能的单独使用或组合使用
  - [x] 支持对jpeg格式图片进行图片质量压缩
  - [x] 支持对jpeg/png/svg格式图片在保持原始宽高比的前提下压缩分辨率
  - [x] 支持对图片批量添加自定义文本水印
  - [x] 支持批量重命名（统一添加文件名前缀或后缀，不影响原始文件扩展名）
  - [x] 支持将png/svg图片统一转换为jpg格式图片

#### 任务二：用bash编写一个文本批处理脚本，对以下附件分别进行批量处理完成相应的数据统计任务：

- [x] 统计不同年龄区间范围（20岁以下、[20-30]、30岁以上）的球员数量、百分比
- [x] 统计不同场上位置的球员数量、百分比
- [x] 名字最长的球员是谁？名字最短的球员是谁？
- [x] 年龄最大的球员是谁？年龄最小的球员是谁？

#### 任务三：用bash编写一个文本批处理脚本，对以下附件分别进行批量处理完成相应的数据统计任务：

- [x] 统计访问来源主机TOP 100和分别对应出现的总次数
- [x] 统计访问来源主机TOP 100 IP和分别对应出现的总次数
- [x] 统计最频繁被访问的URL TOP 100
- [x] 统计不同响应状态码的出现次数和对应百分比
- [x] 分别统计不同4XX状态码对应的TOP 10 URL和对应出现的总次数
- [x] 给定URL输出TOP 100访问来源主机



---

## 实验过程

**1. 任务一**

**①支持命令行参数方式使用不同功能**

使用`getopts`进行处理，参考资料见报告末

**②支持对指定目录下所有支持格式的图片文件进行批处理**

使用magick里面的命令 identify -format "%m" 文件名
能够得到文件的类型，即使改了后缀也可以看真正的类型
​

**③支持以下常见图片批处理功能的单独使用或组合使用**

​```bash
#对jpeg格式图片进行图片质量压缩
convert -strip -interlace Plane -gaussian-blur 0.01 -quality "$Q" "$jpg" "$jpg"

#对jpeg/png/svg格式图片在保持原始宽高比的前提下压缩分辨率
convert -resize "$R" "$img" "$img"

#支持对图片批量添加自定义文本水印
#加非透明水印时
convert "${img}" -pointsize "$size" -fill 'rgba(221, 34, 17, 0.25)' \
-gravity "$position" -draw "text 10,10 '$content'" "${img}"

#加透明水印时
convert  -size 100x100  xc:none  \
-fill '#d90f02'  -pointsize "$size"  -font 'cochin.ttc'  \
-gravity "$position" -draw "rotate -45 text 0,0 '$content'"  \
-resize 60%  miff:-  |  composite  -tile  -dissolve 25  -  "$img"  "$img"


#支持批量重命名（统一添加文件名前缀或后缀，不影响原始文件扩展名）
#添加前缀
name=${img##*/}
new_name=$1"/"${prefix}${name}
mv "${img}" "${new_name}"
#添加后缀
new_name=${img%.*}${suffix}"."${type}
mv "${img}" "${new_name}"

#支持将png/svg图片统一转换为jpg格式图片
new_img=${img%.*}".jpg"
convert "${img}" "$new_img"

​```



在Travis-CI测试

![travis](./img/1.png)

![travis](./img/2.png)

---

**2. 任务二**

**①统计不同年龄区间范围（20岁以下、[20-30]、30岁以上）的球员数量、百分比**

​```bash
if ($6<20) {small++;}
else if ($6<=30) {middle++;}
else {high++;}
​```

**②统计不同场上位置的球员数量、百分比**

​```bash
NR>1 {
        position[$5]++;
        total++;
    }
​```


**③名字最长的球员是谁？名字最短的球员是谁？**

​```bash
FindName(){
    awk -F '\t'  'BEGIN{ 
    age[$9]=length($9);       
    for(i=1;i<=asort(age,nage);i++){
    	print i "\t" nage[i]
	}}
    NR>1 {                    
    }
    END{           
        printf("------------------------------------------\n")
        printf("| 拥有最长名字的运动员\t | 拥有最短名字的运动员\t | \n")
        printf("------------------------------------------\n")       

    }'  worldcupplayerinfo.tsv
    exit 0
}

# 于是换了下面的写法

awk -F '\t' 'BEGIN{ max=0; min=100; }
    NR>1 { 
        let=length($9);
        names[$9]=let;
        max=let>max?let:max;
        min=let<min?let:min; 
    }        
    END{
        for(i in names){            
            if(names[i]==max){
                print " 拥有最长名字的运动员:\t "i
            }
            else if(names[i]==min){
                print " 拥有最短名字的运动员:\t "i 
            }
        }
    } ' worldcupplayerinfo.tsv
​```



**④年龄最大的球员是谁？年龄最小的球员是谁？**

​```bash
    awk -F '\t' 'BEGIN{ max=0; min=100; }
    NR>1 {
        ages[$9]=$6;
        max=$6>max?$6:max;
        min=$6<min?$6:min;
    }
    END{
        for(i in ages){
            if(ages[i]==max){
                print "最年长的球员: "ages[i]"\t name: " i "\t";
            }
            else if(ages[i]==min){
                print "最年轻的球员: "ages[i]"\t name: " i "\t";
            }
        }
    }' worldcupplayerinfo.tsv
​```



**注：**

1. `awk`的执行语句（单引号所包围的）一定要和awk 放在一行，不然会报错

2. 下载的文件链接为`https://github.com/EddieXu1125/LinuxSysAdmin/blob/master/exp/chap0x04/worldcupplayerinfo.tsv` 时得到的是一个html内容（虽然是tsv后缀），改为了`https://raw.githubusercontent.com/EddieXu1125/LinuxSysAdmin/master/exp/chap0x04/worldcupplayerinfo.tsv`

3. The "NR > 1" is true only for lines greater than one, so it does not get executed on the first line. On the first line only the "1", the true statement, gets executed. It makes Awk print the line and read the next line.

   略去文件第一行，往后读取  


---

在Travis-CI测试

![](./img/3.png)

**3. 任务三**

**①统计访问来源主机TOP 100和分别对应出现的总次数**

​```bash
awk -F '\t' '
    NR>1{hosts[$1]++;}
    END{      
        for( host in hosts ){
            print hosts[host] "\t|" host "\t\n";
        }
    }
    ' web_log.tsv | sort -k1 -rg | head -100

​```



**②统计访问来源主机TOP 100 IP和分别对应出现的总次数**

​```bash
awk -F '\t' '
    NR>1 { 
        if(match($1,/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/)){
            hosts[$1]++; 
        }          
    }
    END{ 
        for(host in hosts){
            print hosts[host] "\t" host "\t\n";
        }
    }' web_log.tsv | sort -k1 -rg | head -100

​```



**③统计最频繁被访问的URL TOP 100**

​```bash
awk -F '\t' '
    NR>1{
        print $5
    }
    ' web_log.tsv | sort | uniq -c | sort -nr | head -100
​```



**④统计不同响应状态码的出现次数和对应百分比**

​```bash
awk -F '\t' 'BEGIN{total=0}
    NR>1{
        state[$6]++;
        total++;
    }
    END{
        for( s in state ){
            printf("%s\t%d\t%.6f\t\n",s,state[s],state[s]/total) 
        }

    }' web_log.tsv 
​```



**⑤分别统计不同4XX状态码对应的TOP 10 URL和对应出现的总次数**

​```bash
awk -F '\t' '
    NR>1{
        if(match($6,/^4[0-9]{2}$/)){
            urls[$6][$5]++;
        }
    }
    END{ 
        for(k1 in urls){
            for(k2 in urls[k1]){
                print k1, urls[k1][k2], k2;
            }
        }
    }' web_log.tsv | sort -k1,1 -k2,2gr | head -10
    
awk -F '\t' '
    NR>1{
        if(match($6,/^4[0-9]{2}$/)){
            urls[$6][$5]++;
        }
    }
    END{ 
        for(k1 in urls){
            for(k2 in urls[k1]){
                print k1, urls[k1][k2], k2;
            }
        }
    }' web_log.tsv | sort -k1,1r -k2,2gr | head -10

​```



**⑥给定URL输出TOP 100访问来源主机**

​```bash
awk -F '\t' -v url="$1" '
    NR>1{
        if(url==$5){
            print $1 
        }
    }
    ' web_log.tsv | sort | uniq -c | sort -nr | head -100
​```
  
   在Travis-CI测试
   
   ![travis4](./img/4.png)

---



## 参考资料
* [如何使用getopts](https://stackoverflow.com/questions/16483119/an-example-of-how-to-use-getopts-in-bash)
* [如何使用magick](https://segmentfault.com/a/1190000015210920)
* [linux中shell截取字符串方法总结](http://www.111cn.net/sys/linux/43822.htm)
* [EddieXu1125实验报告](https://github.com/CUCCS/2021-linux-public-EddieXu1125/tree/chap0x04/chap0x04)

